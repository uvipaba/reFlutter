name: Docker Build

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      snapshot_hash:
        description: 'Snapshot Hash'
        required: true
        default: 'd91c0e6f35f0eb2e44124e8f42aa44a7'
      engine_commit:
        description: 'Engine Commit'
        required: true
        default: 'cf56914b326edb0ccb123ffdc60f00060bd513fa'
      build_arm64:
        description: 'Build ARM64'
        type: boolean
        default: true
      build_arm:
        description: 'Build ARM'
        type: boolean
        default: false
      build_x64:
        description: 'Build x64'
        type: boolean
        default: false
  pull_request:
    branches:
      - "*"

jobs:
  docker-build:
    runs-on: ubuntu-latest  # Changed from macos-14 to ubuntu
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          
          # Remove unnecessary software to free up ~30GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          
          # Remove large packages (ignore errors if not installed)
          sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri 2>/dev/null || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          
          # Remove docker images
          docker rmi $(docker image ls -aq) 2>/dev/null || true
          
          echo "Disk space after cleanup:"
          df -h
      
      - name: Set variables
        run: |
          # Use workflow inputs if triggered manually, otherwise use SNAPSHOT_HASH file
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "SNAPSHOT_HASH=${{ github.event.inputs.snapshot_hash }}" >> $GITHUB_ENV
            echo "ENGINE_COMMIT=${{ github.event.inputs.engine_commit }}" >> $GITHUB_ENV
            echo "BUILD_ARM64=${{ github.event.inputs.build_arm64 }}" >> $GITHUB_ENV
            echo "BUILD_ARM=${{ github.event.inputs.build_arm }}" >> $GITHUB_ENV
            echo "BUILD_X64=${{ github.event.inputs.build_x64 }}" >> $GITHUB_ENV
          else
            HASH=$(cat SNAPSHOT_HASH 2>/dev/null || echo "d91c0e6f35f0eb2e44124e8f42aa44a7")
            echo "SNAPSHOT_HASH=$HASH" >> $GITHUB_ENV
            echo "ENGINE_COMMIT=cf56914b326edb0ccb123ffdc60f00060bd513fa" >> $GITHUB_ENV
            echo "BUILD_ARM64=true" >> $GITHUB_ENV
            echo "BUILD_ARM=false" >> $GITHUB_ENV
            echo "BUILD_X64=false" >> $GITHUB_ENV
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t reflutter -f Dockerfile .
      
      - name: Run Docker build (ARM64 only)
        run: |
          echo "Building ARM64 only to save disk space"
          
          docker run \
            -e WAIT=10 \
            -e HASH_PATCH=${{ env.SNAPSHOT_HASH }} \
            -e COMMIT=${{ env.ENGINE_COMMIT }} \
            --rm \
            -v $PWD:/t \
            reflutter
      
      - name: Verify built files
        run: |
          echo "Checking for ARM64 library..."
          if [ -f libflutter_arm64.so ]; then
            ls -lh libflutter_arm64.so
            echo "✅ ARM64 build successful!"
          else
            echo "❌ ARM64 build failed - file not found"
            exit 1
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libflutter-arm64-${{ env.SNAPSHOT_HASH }}
          path: libflutter_arm64.so
          retention-days: 30
      
      - name: Create Release (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: docker-build-${{ env.SNAPSHOT_HASH }}
          name: Docker Build - ${{ env.SNAPSHOT_HASH }}
          body: |
            Patched Flutter engine (ARM64 only) built via Docker
            
            **Build Configuration:**
            - Snapshot Hash: ${{ env.SNAPSHOT_HASH }}
            - Engine Commit: ${{ env.ENGINE_COMMIT }}
            - Architecture: ARM64 (arm64-v8a)
            
            **Usage:**
            ```bash
            reflutter your-app.apk
            ```
          files: libflutter_arm64.so
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
